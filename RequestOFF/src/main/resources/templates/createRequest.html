<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Create Request</title>
		<link rel="stylesheet" type="text/css" href="css/layoutStyle.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" type="text/css" href="css/createRequestStyle.css" />
		<link rel="stylesheet"	type="text/css" href="css/bootstrap.min.css" />
		<link rel="stylesheet"	type="text/css" href="css/notify.css" />
		<link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css"/>
		<script src="javascript/jquery-3.2.1.js"></script>
		<script src="javascript/bootstrap.min.js"></script>
		<script src="javascript/jquery.serializejson.js"></script>
		<script src="javascript/common.js"></script>
		<script src="javascript/notify.js"></script>
		<script type="text/javascript" src="javascript/datatables.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-confirmation.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-datepicker.min.js"></script>
	</head>
	<body class="content-body">
		<script th:inline="javascript">
		/*<![CDATA[*/
			var employee;
			var employeeId;
			var remainHours;
			
			$(function() {
				var getStatus = {
					'1': 'saved',
					'2': 'approved',
					'3': 'denied',
					'4': 'responded',
					'5': 'waiting'
				};
				
				//get current user
				$.ajax({
					type : "POST",
					contentType : "application/json",
					url : /*[[@{/employee/getUser}]]*/,
					dataType : 'json',
					data : JSON.stringify({}),
					success : function(returnData) {
						console.log(returnData);
						employee = returnData.user;
						employeeId = employee.id;
						remainHours = returnData.remainHours;
						
						renderRemainHours(returnData.remainHours, 'remainHours');
						renderDayOffTypeSelect('id_dayOffType');
						renderRecipientSelect(returnData.listRecipients, 'id_recipient');
					},
					error : function(e) {
						$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
					}
				});

				$('.datepicker').on('changeDate', function(ev){
					$(this).datepicker('hide');
				});
				
				$('#btnSave, #btnSend').on('click', function() {
					var status, alertStr;
					if($(this).attr('id') == 'btnSave') {
						status = 1;
						alertStr = "Your request has been saved";
					}
					else {
						if(employee.position.name.localeCompare("project manager") == 0) {
							status = 2;
						}
						else {
							status = 5;
						}
						alertStr = "Your request has been sent";
					}
					
					//validate
					var complete = 1, valid = 1, roundHours = 1, exceed = 0, offHoursEqual0 = 0;
					var listInput = $('#createRequestForm').find(':input').not("button");
					$.each(listInput, function() {
						if($(this).val() == "") {
							complete = 0;
						}
					});
					
					var createRequestData = $('#createRequestForm').serializeJSON();
					var offHours = parseInt(createRequestData.offDays) * 8 + parseInt(createRequestData.offHours);
					if(offHours == 0){
						offHoursEqual0 = 1;
					}
					else {
						if(parseInt(offHours) > parseInt(remainHours)) {
							exceed = 1;
						}
					}
					
					var fromDate = createRequestData.from;
					fromDate = fromDate.substr(6, 4) + "-" + fromDate.substr(0, 2) + "-" + fromDate.substr(3, 2);
					var fromTime = createRequestData.hourFrom + ":" + createRequestData.minuteFrom + ":00.0";
					var from = fromDate + " " + fromTime;
					var toDate = createRequestData.to;
					toDate = toDate.substr(6, 4) + "-" + toDate.substr(0, 2) + "-" + toDate.substr(3, 2);
					var toTime = createRequestData.hourTo + ":" + createRequestData.minuteTo + ":00.0";
					var to = toDate + " " + toTime;
					
					if(createRequestData.minuteFrom.localeCompare(createRequestData.minuteTo) != 0) {
						roundHours = 0;
					}
					if(from.localeCompare(to) >= 0) {
						valid = 0;
					}
					//end validate
					
					if(complete == 0) {
						$('#alertMessage').html(errors['incompleteFields']).attr('class', 'alert alert-danger').show();
					}
					else if(roundHours == 0) {
						$('#alertMessage').html(errors['roundHour']).attr('class', 'alert alert-danger').show();
					}
					else if(valid == 0) {
						$('#alertMessage').html(errors['DateError']).attr('class', 'alert alert-danger').show();
					}
					else if(offHoursEqual0 == 1) {
						$('#alertMessage').html(errors['offHoursEqual0']).attr('class', 'alert alert-danger').show();
					}
					else if(exceed == 1) {
						$('#alertMessage').html(errors['exceedTime']).attr('class', 'alert alert-danger').show();
					}
					else {
						var requestRegistRequest = {
							"id" : "",
							"employee_id" : employeeId,
							"from_time" : from,
							"to_time" : to,
							"total_time" : offHours,
							"reason" : createRequestData.reason,
							"status" : status,
							"response_message" : "",
							"day_off_type_id" : createRequestData.dayOffType,
							"recipient_id" : createRequestData.recipient,
							"valid_flag" : "1",
							"update_date" : ""
						};
						console.log(requestRegistRequest);
						$.ajax({
							type : "POST",
							contentType : "application/json",
							url : /*[[@{/request/regist}]]*/,
							dataType : 'json',
							data : JSON.stringify(requestRegistRequest),
							success : function(returnData) {
								//get current user
								$.ajax({
									type : "POST",
									contentType : "application/json",
									url : /*[[@{/employee/getUser}]]*/,
									dataType : 'json',
									data : JSON.stringify({}),
									success : function(returnData) {
										renderRemainHours(returnData.remainHours, 'remainHours');
									},
									error : function(e) {
										$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
									}
								});
								
								$("#createRequestForm :input").not("button, select").val("");
								$("#createRequestForm select").prop('selectedIndex', 0);
								$('#alertMessage').html(alertStr).attr('class', 'alert alert-success').show();
							},
							error : function(e) {
								$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
							}
						});
					}
				});
				
				$('#btnClear').on('click', function() {
					$("#createRequestForm :input").not("button, select").val("");
					$("#createRequestForm select").prop('selectedIndex', 0);
				});
			});
				
		/*]]>*/
		</script>

		<div>
			<div th:replace="fragments/header"></div>
			<div th:replace="menu"></div>

			<div class="requestOffContentBody">
				<h2>Create Request</h2>
				<div>
					<div id="alertMessage" class="alert" style="display:none;"></div>
					<h4>You have <span id="remainHours" style="font-weight: bold;"></span> of off time with payment left</h4>
					<form id="createRequestForm" class="form-input">
						<div class="form-group">
							<label>From * </label>
							<div class="row">
								<div class="col-sm-6">
									<div class="input-group date datepicker" data-provide="datepicker">
										<input type="text" class="form-control" name="from"/>
										<div class="input-group-addon">
											<span class="glyphicon glyphicon-th"></span>
										</div>
									</div>
								</div>	
								
								<div class="col-sm-6 form-inline" style="text-align: right;">
									<label>Hours * </label>
									<select class="form-control" name="hourFrom" style="width:100px;">
										<option value="08">8</option>
										<option value="09">9</option>
										<option value="10">10</option>
										<option value="11">11</option>
										<option value="12">12</option>
										<option value="13">13</option>
										<option value="14">14</option>
										<option value="15">15</option>
										<option value="16">16</option>
										<option value="17">17</option>
									</select>&nbsp;:&nbsp;
									<select class="form-control" name="minuteFrom" style="width:100px;">
										<option value="00">00</option>
										<option value="05">05</option>
										<option value="10">10</option>
										<option value="15">15</option>
										<option value="20">20</option>
										<option value="25">25</option>
										<option value="30">30</option>
										<option value="35">35</option>
										<option value="40">40</option>
										<option value="45">45</option>
										<option value="50">50</option>
										<option value="55">55</option>
									</select>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label>To * </label>
							<div class="row">
								<div class="col-sm-6">
									<div class="input-group date datepicker" data-provide="datepicker">
										<input type="text" class="form-control" name="to"/>
										<div class="input-group-addon">
											<span class="glyphicon glyphicon-th"></span>
										</div>
									</div>
								</div>
								<div class="col-sm-6 form-inline" style="text-align: right;">
									<label>Hours * </label>
									<select class="form-control" name="hourTo" style="width:100px;">
										<option value="08">8</option>
										<option value="09">9</option>
										<option value="10">10</option>
										<option value="11">11</option>
										<option value="12">12</option>
										<option value="13">13</option>
										<option value="14">14</option>
										<option value="15">15</option>
										<option value="16">16</option>
										<option value="17">17</option>
									</select>&nbsp;:&nbsp;
									<select class="form-control" name="minuteTo" style="width:100px;">
										<option value="00">00</option>
										<option value="05">05</option>
										<option value="10">10</option>
										<option value="15">15</option>
										<option value="20">20</option>
										<option value="25">25</option>
										<option value="30">30</option>
										<option value="35">35</option>
										<option value="40">40</option>
										<option value="45">45</option>
										<option value="50">50</option>
										<option value="55">55</option>
									</select>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label>Off hours * </label>
							<div class="form-inline">
								<select class="form-control" name="offDays" style="width:100px;">
									<option value="0">0</option>
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
									<option value="4">4</option>
									<option value="5">5</option>
									<option value="6">6</option>
									<option value="7">7</option>
									<option value="8">8</option>
									<option value="9">9</option>
									<option value="10">10</option>
									<option value="11">11</option>
									<option value="12">12</option>
								</select>&nbsp;day(s)&nbsp;
								<select class="form-control" name="offHours" style="width:100px;">
									<option value="0">0</option>
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
									<option value="4">4</option>
									<option value="5">5</option>
									<option value="6">6</option>
									<option value="7">7</option>
									<option value="8">8</option>
								</select>&nbsp;hour(s)
							</div>
						</div>
						<div class="form-group">
							<label>Reason * </label>
							<textarea class="form-control" name="reason" id="id_reason"></textarea>
						</div>
						<div class="form-group">
							<label>Day off type * </label>
							<select class="form-control" name="dayOffType" id="id_dayOffType">
							</select>
						</div>
						<div class="form-group">
							<label>Send to * </label>
							<select class="form-control" name="recipient" id="id_recipient">
							</select>
						</div>
						<br/>
						<div>
							<button type="button" class="btn btn-primary" id="btnSave">Save</button>&nbsp;&nbsp;
							<button type="button" class="btn btn-primary" id="btnSend">Send</button>&nbsp;&nbsp;
							<button type="button" class="btn btn-primary" id="btnClear">Clear</button>
						</div>
					</form>
				</div>
			</div>
			<div th:replace="fragments/footer"></div>
		</div>

	</body>
</html>