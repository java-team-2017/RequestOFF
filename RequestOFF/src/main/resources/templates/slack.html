<!DOCTYPE html>
<html>
<head>
	<title>Quản lý request từ Slack</title>
	<meta charset="UTF-8"/>
	<div th:replace="library"></div>
	<link rel="stylesheet" type="text/css" href="css/slackStyle.css" />
</head>

<script th:inline="javascript">
/*<![CDATA[*/
	var rowData; // data of selected row of table
	var row;
	
	$(function() {
		var selectedEmployee = {
			"id" : "",
			"name" : ""
		};
		
		$('.datepicker').on('changeDate', function(ev){
			$(this).datepicker('hide');
		});
		
		$('[data-toggle="tooltip"]').tooltip();
		
		getLoggedUser(function(returnData){
			if(returnData.user.position.code == 2 || returnData.leaderFlag == 1){
				renderNumberOfRequest(returnData.user.id);
			}
		});
		
		$('#editHours').empty();
		for (var i = 0; i < 8 ; i = i + 0.5) {
			$('#detailTotalHour').append('<option value="' + i + '">' + i + '</option>');
		}
		
		search();
		function search() {
			$('#alertMessage').hide();
			var searchData = {
				is_valid_msg: $('#validStatus').val(),
				process_flag: $('#processStatus').val()
			}
			var fromTime = new Date($('#from').val());
			var toTime = new Date($('#to').val());
			if (fromTime != 'Invalid Date' && toTime != 'Invalid Date' && fromTime.getTime() > toTime.getTime()) {
				$('#alertMessage').html(errors['DateError']).attr('class', 'alert alert-danger').show();
				return;
			}
				
			if (fromTime != 'Invalid Date') {
				searchData.msg_time_from = fromTime.getTime();
			}
			
			if (toTime != 'Invalid Date') {
				var nextDay = new Date(toTime);
				nextDay.setDate(toTime.getDate()+1);
				searchData.msg_time_to = nextDay.getTime()-1;
			}
			console.log(searchData);
			
			$('#slackRequestTable').DataTable({
				destroy: true,
				searching: false,
				ajax: {
					'url' : /*[[@{/slack/search}]]*/,
					'type': "POST",
					contentType : "application/json",
					'data': function () {
						return JSON.stringify(searchData);
					},
					'dataSrc': 'slackRequests'
				},
				columns: [
					{ data: 'id' },
					{
						data: 'msgTime',
						render: function (data, type, row){
							if (type == 'display' || type == 'filter') { // for display and search
								var m = new Date(data);
								var dateString = m.getHours() + ":" + m.getMinutes() + ":" + m.getSeconds() + " " + m.getDate() +"/"+ (m.getMonth()+1) +"/"+ m.getFullYear();
								return dateString;
							} else { // for sort and type detection
								if (data == "") return 0;
								return data;
							}
						}
					},
					{ data: 'name' },
					{ data: 'msgContent' },
					{ data: 'dayOffFrom' },
					{ data: 'dayOffTo' },
					{
						data: 'totalHours',
						render: function (data, type, row){
							if (type == 'display' || type == 'filter') { // for display and search
								if (data == "") data = 0;
								return Math.floor(data/8) + "d " + (data % 8) + "h";
							} else { // for sort and type detection
								if (data == "") return 0;
								return data;
							}
						}
					},
					{ data: 'errMsg' },
					{
						"orderable": false,
						data: null,
						render: function (data, type, row){
							if(row.isValidMsg != 1 && row.processFlag != 1) {
								return '<a data-toggle="tooltip" title="Từ chối" class="btnDeny"><span class="glyphicon glyphicon-remove" style="cursor: pointer;"></span></a>';
							}
							else {
								return "<a class='btnDeny not-active'><span class='glyphicon glyphicon-remove' style='opacity: 0.5;'></span></a>";
							}
						}
					}
				]
			});
		}
		$('#searchBtn').on('click', function() {
			search();
		});
		$('#slackRequestTable tbody').on('click', 'td', function() {
			var index = $(this).index();
			if(index > 7) return;
			row = $('#slackRequestTable').DataTable().row(this);
			rowData = $('#slackRequestTable').DataTable().row(this).data();
			$('#modalMsg').hide();
			if (rowData.processFlag == 1 || (rowData.processFlag == 0 && rowData.isValidMsg == 1)) {
				$('#modalDenyBtn, #modalApproveBtn').hide();
				$('#detailModal .modal-input, #detailNameSearch').prop('disabled', true);
			} else {
				$('#modalDenyBtn, #modalApproveBtn').show();
				$('#detailModal .modal-input, #detailNameSearch').prop('disabled', false);
			}
			
			$('#detailId').val(rowData.id);
			var m = new Date(rowData.msgTime);
			var dateString = m.getHours() + ":" + m.getMinutes() + ":" + m.getSeconds() + " " + m.getDate() +"/"+ (m.getMonth()+1) +"/"+ m.getFullYear();
			$('#detailMsgTime').val(dateString);
			$('#detailName').val(rowData.name);
			$('#detailMsgContent').val(rowData.msgContent);
			if (rowData.dayOffFrom != null) {
				var dayOffFrom = new Date(rowData.dayOffFrom);
				if (dayOffFrom != 'Invalid Date') {
					$('#detailFrom').val((dayOffFrom.getMonth()+1) +"/"+ dayOffFrom.getDate() +"/"+ dayOffFrom.getFullYear());				
				} else {
					$('#detailFrom').val("");
				}
			} else {
				$('#detailFrom').val("");
			}
			
			if (rowData.dayOffTo != null) {
				var dayOffTo = new Date(rowData.dayOffTo);
				if (dayOffTo != 'Invalid Date') {
					$('#detailTo').val((dayOffTo.getMonth()+1) +"/"+ dayOffTo.getDate() +"/"+ dayOffTo.getFullYear());
				} else {
					$('#detailTo').val("");
				}
			} else {
				$('#detailTo').val("");
			}
			
			if (rowData.isValidMsg == 1) {
				$('#detailValidStatus').attr('class', 'glyphicon glyphicon-ok');
			} else {
				$('#detailValidStatus').attr('class', 'glyphicon glyphicon-remove');
			}
			if (rowData.processFlag == 1) {
				$('#detailProcessFlag').attr('class', 'glyphicon glyphicon-ok');
			}else {
				$('#detailProcessFlag').attr('class', 'glyphicon glyphicon-remove');
			}
			$('#detailTotalDay').val( Math.floor(rowData.totalHours/8));
			$('#detailTotalHour').val(rowData.totalHours % 8);

			$('#detailModal').modal('show');
		});
		
		$('#detailNameSearch').on('click', function() {
			$('#searchEmModal').modal('show');
			searchEm({
				"name" : "",
				"valid_flag" : "1"
			});
		});
		
		$('#btnSearch_searchEmModal').on('click', function() {
			searchEm({
				"name" : $('#nameSearchEmModalId').val(),
				"valid_flag" : "1"
			});
		});
		
		$("body").on("click", ".btnSelect", function(event) {
			var row = $(this).closest("tr");	// Finds the closest row <tr> 
			selectedEmployee.id = $('input[name=selectSearchEmModal]:checked').val();
			selectedEmployee.name = row.find("td:nth-child(3)").html();
		});
		
		$('#btnOk_searchEmModal').on('click', function() {
			if(selectedEmployee.name == "" || selectedEmployee.name === undefined || selectedEmployee.name === null) {
				$('#alertMessage_searchEmModal').html('Vui lòng chọn một nhân viên').attr('class', 'alert alert-danger').show();
				return;
			}
			$('#detailName').val(selectedEmployee.name);
			$('#searchEmModal').modal('hide');
		});
		
		$('body').on('click', '#modalDenyBtn, #modalApproveBtn, #slackRequestTable .btnDeny', function() {
			var updateData = {};
			var action = "";
			if ($(this).attr('id') == 'modalApproveBtn') {
				action = 'modal approve';
			} else if ($(this).attr('id') == 'modalDenyBtn') {
				action = 'modal deny';
			} else if ($(this).hasClass('btnDeny')) {
				action = 'table deny';
				rowData = $('#slackRequestTable').DataTable().row($(this).parent()).data();
			}
			
			if (action == 'modal approve') { // click save or approve button on detail modal
				var complete = 1;
				$('#detailModal .modal-input').each(function() {
					if ($(this).val() == "") {
						$('#modalMsg').html(errors['incompleteFields']).attr('class', 'alert alert-danger').show();
						complete = 0;
					}
				});
				if(complete == 0) {
					return;
				}
				
				var fromTime = new Date($('#detailFrom').val());
				var toTime = new Date($('#detailTo').val());
				var days = $('#detailTotalDay').val();
				var hours = $('#detailTotalHour').val();
				if (toTime < fromTime) {
					$('#modalMsg').html(errors['DateError']).attr('class', 'alert alert-danger').show();
					return;
				}
				if (isNaN(parseInt(days)) || parseInt(days) != parseFloat(days) || parseInt(days) < 0) {
					$('#modalMsg').html("Số ngày nghỉ phải là số nguyên dương").show();
					return;
				}
				var totalTime = parseFloat(days) * 8 + parseFloat(hours);
				if (totalTime == 0) {
					$('#modalMsg').html("Thời gian nghỉ phải lớn hơn 0 giờ").show();
					return;
				}
			}
			
			if (action == 'modal approve') {
				$('#confirmModalMessage').html("Bạn có chắc chắn muốn cập nhật request này?");
				$('#confirmModalTitle').html("Xác nhận cập nhật");
				$('#action_confirmModalId').val(action);
			} else if (action == 'modal deny' || action == 'table deny') {
				$('#confirmModalMessage').html("Bạn có chắc chắn muốn từ chối request này?");
				$('#confirmModalTitle').html("Xác nhận từ chối");
				$('#action_confirmModalId').val(action);
			}
			
			$('#confirmModal').modal('show');
		});
		
		$('#yesConfirm').on('click', function() {
			var action = $('#action_confirmModalId').val();
			updateRequest(action);
		});
		
		function searchEm(employeeSearchRequest) {
			$('#alertMessage_searchEmModal').hide();
			$('#searchEmTable').DataTable({
				ajax: {
					type : "POST",
					contentType : "application/json",
					url : /*[[@{/employee/search}]]*/,
					dataType : 'json',
					data : function() {
						return JSON.stringify(employeeSearchRequest);
					},
					dataSrc: 'employees'
				},
				destroy: true,
				searching: false,
				order: [[ 1, "asc" ]],
				pageLength: 10,
				columnDefs: [
					{
						"targets": [ 0 ],
						"orderable": false,
						"className": "text-center",
						"data": null,
						"render": function(data, type, row) {
							return "<a class='btnSelect'><input type='radio' name='selectSearchEmModal' value='" + row.id + "' /></a>"
						}
					},
					{
						"className": 'hideColumn',
						"targets": [ 1 ],
						"data": 'id'
					},
					{
						"targets": [ 2 ],
						"data": 'name'
					},
					{
						"targets": [ 3 ],
						"data": 'birthday'
					}
				]
			});
		}
		
		function updateRequest(action) {
			if (action == 'modal approve') { // click save or approve button on detail modal
				var fromTime = new Date($('#detailFrom').val());
				var toTime = new Date($('#detailTo').val());
				var fromTimeString = fromTime.getFullYear() +"-"+ (fromTime.getMonth()+1) +"-"+ fromTime.getDate();
				var toTimeString = toTime.getFullYear() +"-"+ (toTime.getMonth()+1) +"-"+ toTime.getDate();
				
				var days = $('#detailTotalDay').val();
				var hours = $('#detailTotalHour').val();
				var totalTime = parseFloat(days) * 8 + parseFloat(hours);
				
				updateData = {
					id: rowData.id,
					update_date: rowData.updateDate,
					name: selectedEmployee.name,
					employee_id: selectedEmployee.id,
					day_off_from: fromTimeString,
					day_off_to: toTimeString,
					total_hours: totalTime,
					is_valid_msg: 1,
					process_flag: 1
				}
			} else if (action == 'modal deny') { // click deny button on detail modal
				updateData = {
					id: rowData.id,
					update_date: rowData.updateDate,
					process_flag: 1
				}
				
			} else if (action == 'table deny') { // click deny sign on table
				updateData = {
					id: rowData.id,
					update_date: rowData.updateDate,
					process_flag: 1
				}
			}
			
			$.ajax({
				url : /*[[@{/slack/regist}]]*/,
				type : "post",
				dataType :"json",
				contentType : "application/json",
				data : JSON.stringify(updateData),
				success : function (response){
					$('#slackRequestTable').DataTable().ajax.reload();
					if (response.status_info.status != 0) {
						if (action == 'modal approve') {
							$('#modalMsg').html(errors['APIResponseError'](response.status_info.error)).attr('class', 'alert alert-danger').show();
						} else {
							$('#modalMsg').html(errors['APIResponseError'](response.status_info.error)).attr('class', 'alert alert-danger').show();
						}
					} else {
						if (action == 'modal approve') {
							$('#alertMessage').html("Cập nhật thành công").attr('class', 'alert alert-success').show();
						} else if (action == 'modal deny' || action == 'table deny') {
							$('#alertMessage').html("Từ chối thành công").attr('class', 'alert alert-success').show();
						}
						$('#detailModal').modal('hide');
					}
					
				},
				error : function(e) {
					$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
				}
			});
		}
	});
/*]]>*/
</script>

<body class="content-body">
	<div th:replace="fragments/header"></div>
	<div th:replace="menu"></div>
	
	<div class="requestOffContentBody">			
		<h2>Quản lý request từ Slack</h2>
		<div id="alertMessage" class="alert" style="display:none;"></div>
		<fieldset class="filter-fieldset">
			<legend>
				<a href="javascript:void(0);" data-toggle="collapse" data-target=".filter-collapse" class=""><i class="filter-toggle-icon glyphicon glyphicon-triangle-right"></i> Khung tìm kiếm</a>
			</legend>
			<div class="filter-collapse collapse">
				<form id="slackForm" class="form-input">
					<div class="form-group">
						<label class="control-label">Từ: </label>
						<div class="input-group date datepicker mydatepicker" data-provide="datepicker">
							<input class="form-control" type="text" name="msg_time_from" id="from" value=""></input>
							<div class="input-group-addon">
								<span class="glyphicon glyphicon-th"></span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label">Đến: </label>
						<div class="input-group date datepicker mydatepicker" data-provide="datepicker">
							<input class="form-control" type="text" name="msg_time_to" id="to" value=""></input>
							<div class="input-group-addon">
								<span class="glyphicon glyphicon-th"></span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label">Trạng thái xử lý:</label>
							<select id="processStatus" name="process_flag" class="form-control">
								<option value = ""></option>
								<option value = "0" selected="true">Chưa xử lý</option>
								<option value = "1">Đã xử lý</option>
							</select>
					</div>
					<div class="form-group">
						<label class="control-label">Tính hợp lệ:</label>
							<select id="validStatus" name="is_valid_msg" class="form-control">
								<option value = ""></option>
								<option value = "1">Request hợp lệ</option>
								<option value = "0">Request không hợp lệ</option>
							</select>
					</div>
					<br/>
					<p>
						<button id="searchBtn" type="button" class="btn btn-primary">Tìm kiếm</button>&nbsp;&nbsp;
						<button type="reset" class="btn btn-primary" id="btnClear">Làm mới</button>
					</p>
				</form>
			</div>
		</fieldset>
		
		<br/>
		<div class="table-responsive"> 
			<table class="table table-bordered table-striped table-hover" id="slackRequestTable">
					<col width="3%"/>
					<col width="10%"/>
					<col width="12%"/>
					<col width="44%"/>
					<col width="7%"/>
					<col width="7%"/>
					<col width="5%"/>
					<col width="20%"/>
					<col width="2%"/>
				<thead>
					<tr>
						<th class="text-center" style="width: 40px;">Id</th>
						<th class="text-center">Thời gian</th>
						<th class="text-center">Nhân viên</th>
						<th class="text-center" style="width: 500px;">Nội dung</th>
						<th class="text-center">Từ</th>
						<th class="text-center">Đến</th>
						<th class="text-center">Thời gian nghỉ</th>
						<th class="text-center">Lỗi</th>
						<th class="text-center"></th>
					</tr>
				</thead>
				<tbody class="text-center" style="cursor: pointer;">
				</tbody>
			</table>
		</div>
		
		<div id="detailModal" class="modal fade bd-example-modal-lg">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" align="center">Chi tiết</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-sm-1"></div>
							<div id="modalMsg" class="alert alert-danger" style="display: none;"></div>
							<br/>
						</div>
						<div class="row" style="display: none;">
							<label class="col-sm-4 col-form-label">Id</label>
							<div class="col-sm-8">
								<input id="detailId" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Thời gian</label>
							<div class="col-sm-8">
								<input id="detailMsgTime" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Nhân viên</label>
							<div class="col-sm-8">
								<div class="input-group">
									<input type="text" id="detailName" readonly="readonly" class="col-sm-3 form-control modal-input" placeholder="Tìm nhân viên..." />
									<span class="input-group-btn">
										<button id="detailNameSearch" class="btn btn-secondary" type="button"><span class="glyphicon glyphicon-search"></span></button>
									</span>
								</div>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Từ</label>
							<div class="col-sm-8">
								<div class="input-group date datepicker mydatepicker" data-provide="datepicker">
									<input type="text" class="form-control modal-input" name="fromTime" id="detailFrom" />
									<div class="input-group-addon">
										<span class="glyphicon glyphicon-th"></span>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Đến</label>
							<div class="col-sm-8">
								<div class="input-group date datepicker mydatepicker" data-provide="datepicker">
									<input type="text" class="form-control modal-input" name="fromTime" id="detailTo" />
									<div class="input-group-addon">
										<span class="glyphicon glyphicon-th"></span>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Thời gian nghỉ</label>
							<div class="col-sm-2">
								<input id="detailTotalDay" maxlength="2" class="col-sm-3 form-control modal-input only-positive-number" type="text"></input>
							</div>
							<label class="col-sm-1" style="padding-top: 5px">Ngày</label>
							<div class="col-sm-1"></div>
							<div class="col-sm-2">
								<select id="detailTotalHour" class="form-control modal-input"></select>
							</div>
							<label class="col-sm-1 col-form-label" style="padding-top: 5px">Giờ</label>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Nội dung</label>
							<div class="col-sm-8">
								<textarea id="detailMsgContent" rows="4" cols="10" class="col-sm-3 form-control" readonly="readonly" style="height: 176px;"></textarea>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Hợp lệ</label>
							<div class="col-sm-8">
								<span id="detailValidStatus"></span>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Đã xử lý</label>
							<div class="col-sm-8">
								<span id="detailProcessFlag"></span>
							</div>
						</div>
					</div>
					
					<div class="modal-footer">
						<button id="modalApproveBtn" type="button" class="btn btn-default">Cập nhật</button>
						<button id="modalDenyBtn" type="button" class="btn btn-default">Từ chối</button>
						<button id="modalSaveBtn" type="button" class="btn btn-default" style="display: none;">Lưu</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
					</div>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="searchEmModal" role="dialog">
			<div class="modal-dialog modal-dialog-centered">
				
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Tìm nhân viên</h4>
					</div>
					<div class="modal-body">
						<div id="alertMessage_searchEmModal" class="alert" style="display:none;"></div>
						<form id="searchEmModalForm">
							<div class="form-group">
								<label class="control-label col-sm-3">Tên nhân viên </label>
								<div class="form-inline" style="padding-right:15px;">
									<input type="text" class="form-control" name="nameSearchEmModal" id="nameSearchEmModalId" />&nbsp;&nbsp;
									<button type="button" class="btn btn-primary" id="btnSearch_searchEmModal">Tìm kiếm</button>
								</div>
							</div>
						</form>
						
						<br/>
						
						<table class="display table table-bordered" cellspacing="0" width="100%" id="searchEmTable">
							<thead>
								<tr>
									<th class="text-center"></th>
									<th class="text-center hideColumn">Id</th>
									<th class="text-center">Tên</th>
									<th class="text-center">Ngày sinh</th>
								</tr>
							</thead>
							
							<tbody>
							</tbody>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" id="btnOk_searchEmModal">OK</button>
						<button type="button" class="btn btn-default" data-dismiss="modal" id="btnCancel_searchEmModal">Đóng</button>
					</div>
				</div>
			</div>
		</div>
		
		<div id="confirmModal" class="modal fade" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" id="confirmModalTitle"></h4>
					</div>
					<div class="modal-body">
						<p id="confirmModalMessage"></p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal" id="yesConfirm">Có</button>
						<button type="button" class="btn btn-default" data-dismiss="modal" id="noConfirm">Không</button>
					</div>
					<input type="hidden" id="action_confirmModalId" />
				</div>
			</div>
		</div>
		
	</div>
	<div th:replace="fragments/footer"></div>
</body>
</html>