<!DOCTYPE html>
<html>
	<head>
		<title>Header</title>
		<link rel="stylesheet" type="text/css" href="css/layoutStyle.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" type="text/css" href="css/createRequestStyle.css" />
		<link rel="stylesheet"	type="text/css" href="css/bootstrap.min.css" />
		<link rel="stylesheet"	type="text/css" href="css/notify.css" />
		<link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css"/>
		<script src="javascript/jquery-3.2.1.js"></script>
		<script src="javascript/bootstrap.min.js"></script>
		<script src="javascript/jquery.serializejson.js"></script>
		<script src="javascript/common.js"></script>
		<script src="javascript/notify.js"></script>
		<script type="text/javascript" src="javascript/datatables.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-confirmation.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-datepicker.min.js"></script>
	</head>

<script th:inline="javascript">
//<![CDATA[ 
	$(function() {
		//=====================================================================
		// # Initialize form
		//=====================================================================
		var listDepartment;
		var listTeam;
		
		//Department combobox
		$.ajax({
			url : /*[[@{/department/search}]]*/,
			type : "post",
			dataType :"json",
			contentType : "application/json",
			data : JSON.stringify({
				"valid_flag": 1
			}),
			success : function (departmentSearchResponse){
				if (departmentSearchResponse.status_info.status == 0) {
					listDepartment = departmentSearchResponse.listDepartment;
					$('#department').empty().append('<option value=""></option>');
					$.each(listDepartment, function(index, department) {
						$('#department').append('<option value="' + department.id + '">' + department.name + '</option>');
					});	
				} else {
					$.notify(notification['APIResponseError'](departmentSearchResponse.status_info.error));
				}
			},
			error : function() {
				$.notify(notification['APIResponseError']("connection error"));
			}
		});
		
		//Team combobox
		$.ajax({
			url : /*[[@{/team/search}]]*/,
			type : "post",
			dataType :"json",
			contentType : "application/json",
			data : JSON.stringify({
				"valid_flag": 1
			}),
			success : function (teamSearchResponse){
				if (teamSearchResponse.status_info.status == 0) {
					listTeam = teamSearchResponse.teams;
					$('#team').empty().append('<option value=""></option>');
					$.each(listTeam, function(index, team) {
						$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
					});	
				} else {
					$.notify(notification['APIResponseError'](teamSearchResponse.status_info.error));
				}
			},
			error : function() {
				$.notify(notification['APIResponseError']("connection error"));
			}
		});
		
		//select department event
		$('#department').on('change', function() {
			if ($(this).val() != '') {
				var id = $(this).val();
				var department = $.grep(listDepartment, function(department) {
					return department.id == id;
				})[0];
				teams = department.listTeam;
				$('#team').empty().append('<option value=""></option>');
				$.each(teams, function(index, team) {
					$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
				});
			} else {
				$('#team').empty().append('<option value=""></option>');
				$.each(listTeam, function(index, team) {
					$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
				});
			}
		})
		
		
		//=====================================================================
		// # Button even handler
		//=====================================================================
		$("#searchBtn").on('click', function() {
			var searchParam = $('#searchForm').serializeJSON();
			if (searchParam.from_time != "" && searchParam.to_time != "") {
				var fromTime = new Date(searchParam.from_time);
				var toTime = new Date(searchParam.to_time);
				if (toTime < fromTime) {
					$.notify(notification['DateError']);
					return;
				}
			}
			
			$('#statisticsTable').DataTable({
				destroy: true,
				processing: true,
				serverSide: true,
				searching: false,
// 				pageLength: 2,
				ajax: {
					'url' : /*[[@{/employee/statisticsPaging}]]*/,
					'type': "POST",
					'data': function (data) {
						$.each(searchParam, function (field, val) {
							data[field] = val;
						});
 						return data;
					},
					'dataSrc': 'listEmployeeStatistics'
				},
				columns: [
					{ data: 'employee.id' },
					{ data: 'employee.name' },
					{
						data: 'employee.listTeam[0].department.name',
						render: function (data, type, row){
							if(typeof(row.employee.listTeam[0]) == "undefined") {
								data = row.employee.department.name;
							}
							return data;
						}
					},
					{
						data: 'employee.listTeam[0].name',
						render: function (data, type, row){
							if(typeof(row.employee.listTeam[0]) == "undefined") {
								data = "";
							}
							return data;
						}
					},
					{ data: 'employee.position.name' },
					{ data: 'timeOffWithPaying' },
					{ data: 'timeOffWithoutPaying' },
					{
						data: 'employee.listEmployeeOffStatus[0].remainHours',
						render: function (data, type, row){
							if (type == 'display' || type == 'filter') { // for display and search
								if (data == "") data = 0;
								return Math.round(data/8) + " days (" + data + " h)";
							} else { // for sort and type detection
								if (data == "") return 0;
								return data;
							}
						}
					}
				]
			});
		});
		
		$('#statisticsTable tbody').on('click', 'tr', function() {
			var statisticsTable = $('#statisticsTable').DataTable();
			var statisticsObj = statisticsTable.row(this).data();
			console.log("row data:");
			console.log(statisticsObj);
			
			$('#detailEmployee').val(statisticsObj.employee.name);
			$('#detailPosition').val(statisticsObj.employee.position.name);
			
			if(typeof(statisticsObj.employee.listTeam[0]) == "undefined") {
				$('#detailDepartment').val(statisticsObj.employee.department.name);
				$('#detailTeam').val("");
			} else {
				$('#detailDepartment').val(statisticsObj.employee.listTeam[0].department.name);
				$('#detailTeam').val(statisticsObj.employee.listTeam[0].name);
			}
			
			$('#detailWithPaying').val(statisticsObj.timeOffWithPaying);
			$('#detailWithoutPaying').val(statisticsObj.timeOffWithoutPaying);
			var remainHours = statisticsObj.employee.listEmployeeOffStatus[0].remainHours;
			$('#detailRemainDay').val(Math.round(remainHours/8) + " day (" + remainHours + " h)");
			
			
			$('#withPayingTable').DataTable({
				destroy: true,
				searching: false,
				info: false,
				lengthChange: false,
				paging: false,
// 				scrollY: '200px',
// 				"scrollCollapse": true,
				data: statisticsObj.listRequestWithPaying,
				columns: [
					{ data: 'fromTime' },
					{ data: 'toTime' },
				]
			});
			
			$('#withoutPayingTable').DataTable({
				destroy: true,
				searching: false,
				info: false,
				lengthChange: false,
				paging: false,
				data: statisticsObj.listRequestWithoutPaying,
				columns: [
					{ data: 'fromTime' },
					{ data: 'toTime' },
				]
			});
			
			$('#detailModal').modal('show');
		});
		
		$("#clearBtn").on('click', function() {
			$('#searchForm input, #searchForm select').val('');
			$('#team').empty().append('<option value=""></option>');
			$.each(listTeam, function(index, team) {
				$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
			});
		});
		
		$("#editRemainHours").on('click', function() {
			$("#okRemainHours").show();
			$("#cancelRemainHours").show();
			$("#editRemainHours").hide();
			$('#detailRemainDay').attr('readOnly', false);
			$('#detailRemainDay').attr('placeholder', $('#detailRemainDay').val());
			$('#detailRemainDay').val("");
			alert("undone function");
		});
		
		$("#okRemainHours").on('click', function() {
			$("#okRemainHours").hide();
			$("#cancelRemainHours").hide();
			$("#editRemainHours").show();
			$('#detailRemainDay').attr('readOnly', true);
			alert("undone function");
		});
		
		$("#cancelRemainHours").on('click', function() {
			$("#okRemainHours").hide();
			$("#cancelRemainHours").hide();
			$("#editRemainHours").show();
			$('#detailRemainDay').attr('readOnly', true);
			$('#detailRemainDay').val($('#detailRemainDay').attr('placeholder'));
			alert("undone function");
		});
		
	});
//]]>
</script>

<body class="content-body">
	<div th:replace="fragments/header"></div>
	<div th:replace="menu"></div>
	<div class="requestOffContentBody">
		<div>
			<h2>Request Off Statistics</h2>
			<div id="alertMessage" class="alert" style="display:none;">
			</div>
			<form id="searchForm" class="form-input">
				<div class="form-group">
					<label>From</label>
<!-- 					<input id="fromTime" name="from_time" class="form-control" type="datetime-local" val=""/> -->
					<div class="input-group date datepicker" data-provide="datepicker">
						<input id="fromTime" name="from_time" type="text" class="form-control" />
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-th"></span>
						</div>
					</div>
				</div>
				
				<div class="form-group">
					<label>To</label>
<!-- 					<input id="toTime" name="to_time" class="form-control" type="datetime-local"/> -->
					<div class="input-group date datepicker" data-provide="datepicker">
						<input id="toTime" name="to_time" type="text" class="form-control" />
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-th"></span>
						</div>
					</div>
				</div>
				
				<div class="form-group">
					<label>Department</label>
					<select id="department" name="department_id" class="form-control"></select>
				</div>
				
				<div class="form-group">
					<label>Team</label>
					<select id="team" name="team_id" class="form-control"></select>
				</div>
				
				<div class="form-group">
					<label>Employee</label>
					<input id="employee" name="employee" type="text" class="form-control"></input>
				</div>
				
				<div>
					<button id="searchBtn" type="button" class="btn btn-primary">Search</button>
					<button id="clearBtn" type="button" class="btn btn-primary">Clear</button>
				</div>
			</form>
			
			<table id="statisticsTable" class="table table-striped table-bordered table-hover table-condensed text-center" style="word-wrap: break-word; margin-top: 4em;">
				<col width="3%"/>
  				<col width="15%"/>
  				<col width="10%"/>
  				<col width="10%"/>
  				<col width="10%"/>
  				<col width="20%"/>
  				<col width="20%"/>
  				<col width="12%"/>
				<thead>
					<tr>
						<th class="text-center">ID</th>
						<th class="text-center">Name</th>
						<th class="text-center">Department</th>
						<th class="text-center">Team</th>
						<th class="text-center">Position</th>
						<th class="text-center">Time Off with Paying</th>
						<th class="text-center align-middle">Time Off without Paying</th>
						<th class="text-center align-middle">Remain Days</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		
		<div id="detailModal" class="modal fade bd-example-modal-lg">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" align="center">Details</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<label class="col-sm-3 col-form-label">Employee</label>
							<div class="col-sm-3">
								<input id="detailEmployee" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Position</label>
							<div class="col-sm-3">
								<input id="detailPosition" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Department</label>
							<div class="col-sm-3">
								<input id="detailDepartment" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Team</label>
							<div class="col-sm-3">
								<input id="detailTeam" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Time Off With Paying</label>
							<div class="col-sm-3">
								<input id="detailWithPaying" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Time Off Without Paying</label>
							<div class="col-sm-3">
								<input id="detailWithoutPaying" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Remain Off Days</label>
							<div class="col-sm-3">
								<input id="detailRemainDay" class="form-control" type="text" readonly="readonly"></input>
							</div>
							<div class="col-sm-6">
								<button type="button" id="editRemainHours" class="btn btn-primary">Edit Remain Hours</button>
								<button type="button" id="okRemainHours" class="btn btn-primary" style="display:none;">OK</button>
								<button type="button" id="cancelRemainHours" class="btn btn-primary" style="display:none;">Cancel</button>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<table id="withPayingTable" class="table table-bordered table-hover" style="width: 100%;">
									<caption>Day Off with Paying</caption>
									<thead>
										<tr>
											<th class="col-md-6 text-center">From</th>
											<th class="col-md-6 text-center">To</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
							<div class="col-md-6">
								<table id="withoutPayingTable" class="table table-bordered table-hover" style="width: 100%;">
									<caption>Day Off without Paying</caption>
									<thead>
										<tr>
											<th class="col-md-6 text-center">From</th>
											<th class="col-md-6 text-center">To</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="fragments/footer"></div>
</body>

</html>