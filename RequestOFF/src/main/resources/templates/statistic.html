<!DOCTYPE html>
<html>
	<head>
		<title>Statistics</title>
		<link rel="stylesheet" type="text/css" href="css/layoutStyle.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" type="text/css" href="css/createRequestStyle.css" />
		<link rel="stylesheet"	type="text/css" href="css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/typeahead.js-bootstrap.css"/>
		<script src="javascript/jquery-3.2.1.js"></script>
		<script src="javascript/bootstrap.min.js"></script>
		<script src="javascript/jquery.serializejson.js"></script>
		<script th:inline="javascript" src="javascript/common.js"></script>
		<script type="text/javascript" src="javascript/datatables.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-confirmation.min.js"></script>
		<script type="text/javascript" src="javascript/bootstrap-datepicker.min.js"></script>
		<script type="text/javascript" src="javascript/typeahead.min.js"></script>
	</head>

<script th:inline="javascript">
//<![CDATA[ 
	$(function() {
		//=====================================================================
		// # Initialize form
		//=====================================================================
		var listDepartment;
		var listTeam;
		
		var editEmployee;
		var editEmployeeOffStatus;
		
		// department data handler
		function departmentDataHandler(departments) {
			listDepartment = departments;
		}
		
		function teamDataHandler(teams) {
			listTeam = teams;
		}
		
		//Department combobox
		renderDepartmentSelect("department", departmentDataHandler);
		
		//Team combobox
		renderTeamSelect("team", teamDataHandler);
		
		//Employee text field type ahead
		$('#employee').typeahead({
			name: 'suggest-employee',
			limit: 100,
			hint: false,
			remote: {
				rateLimitWait: 1000,
				url: '/employee/search',
				replace: function (url, uriEncodedQuery){
					return url + "#" + uriEncodedQuery;
				},
				beforeSend: function (jqXhr, settings) {
					jqXhr.setRequestHeader('Content-Type','application/json');
					settings.type = 'POST';
					settings.hasContent = true;
					settings.data = JSON.stringify({"name": $('#employee').val(), "name_match_status": "0"});
				},
				filter: function (data) {
					var result = data.employees;
					var sourceArr = [];
					$.each(result, function(index, object) {
						sourceArr.push(object.name);
					});
					return sourceArr;
				}
			}
		}).bind('typeahead:selected', function(obj, selected, name) {
			$(this).typeahead('setQuery', $("<div/>").html(selected.value).text());
			return false;
		});
		
		//select department event
		$('#department').on('change', function() {
			if ($(this).val() != '') {
				var id = $(this).val();
				var department = $.grep(listDepartment, function(department) {
					return department.id == id;
				})[0];
				teams = department.listTeam;
				$('#team').empty().append('<option value=""></option>');
				$.each(teams, function(index, team) {
					$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
				});
			} else {
				$('#team').empty().append('<option value=""></option>');
				$.each(listTeam, function(index, team) {
					$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
				});
			}
		})
		
		// edit remain off time modal
		$('#editHours').empty();
		for (var i = 0; i < 8 ; i++) {
			$('#editHours').append('<option value="' + i + '">' + i + '</option>');
		}
		//=====================================================================
		// # Button even handler
		//=====================================================================
		function search() {
			var searchParam = $('#searchForm').serializeJSON();
			if (searchParam.from_time != "" && searchParam.to_time != "") {
				var fromTime = new Date(searchParam.from_time);
				var toTime = new Date(searchParam.to_time);
				if (toTime < fromTime) {
					$('#alertMessage').html(errors['DateError']).attr('class', 'alert alert-danger').show();
					return;
				}
			}
			$('#alertMessage').hide();
			
			$('#statisticsTable').DataTable({
				destroy: true,
				processing: true,
				serverSide: true,
				searching: false,
// 				pageLength: 2,
				ajax: {
					'url' : /*[[@{/employee/statisticsPaging}]]*/,
					'type': "POST",
					'data': function (data) {
						$.each(searchParam, function (field, val) {
							data[field] = val;
						});
 						return data;
					},
					'dataSrc': 'listEmployeeStatistics'
				},
				columns: [
					{ data: 'employee.id' },
					{ data: 'employee.name' },
					{
						data: 'employee.listTeam[0].department.name',
						render: function (data, type, row){
							if(typeof(row.employee.listTeam[0]) == "undefined") {
								data = row.employee.department.name;
							}
							return data;
						}
					},
					{
						data: 'employee.listTeam[0].name',
						render: function (data, type, row){
							if(typeof(row.employee.listTeam[0]) == "undefined") {
								data = "";
							}
							return data;
						}
					},
					{ data: 'employee.position.name' },
					{ data: 'timeOffWithPaying' },
					{ data: 'timeOffWithoutPaying' },
					{
						data: 'employee.listEmployeeOffStatus',
						render: function (data, type, row){
							var employeeOffStatus = $.grep(data, function(e){ return e.validFlag == 1; });
							if (employeeOffStatus.length == 0) {
								data = "";
							} else {
								data = employeeOffStatus[0].remainHours;
							}
							if (type == 'display' || type == 'filter') { // for display and search
								if (data == "") data = 0;
								return Math.floor(data/8) + " day " + (data % 8) + " h";
							} else { // for sort and type detection
								if (data == "") return 0;
								return data;
							}
						}
					},
					{
						render: function (){
							return '<a class="editRemainHours"><span class="glyphicon glyphicon-edit"></span></a>';
						}
					}
				]
			});
		}
		$("#searchBtn").on('click', function() {
			search();
		});
		
		//prevent select box from opening when pressing enter after selecting
		$("#searchForm select").keydown(function(e){
			if(e.keyCode == 13) {
				this.blur();
			}
		});
		
		//search when pressing enter
		$(document).keypress(function(e) {
			if(e.which == 13) {
				search();
			}
		});
		
		$('#statisticsTable tbody').on('click', 'td', function() {
			if($(this).index() >= 8) return;
			var statisticsTable = $('#statisticsTable').DataTable();
			var statisticsObj = statisticsTable.row(this).data();
// 			console.log("row data:");
// 			console.log(statisticsObj);
			
			$('#detailEmployee').val(statisticsObj.employee.name);
			$('#detailPosition').val(statisticsObj.employee.position.name);
			
			if(typeof(statisticsObj.employee.listTeam[0]) == "undefined") {
				$('#detailDepartment').val(statisticsObj.employee.department.name);
				$('#detailTeam').val("");
			} else {
				$('#detailDepartment').val(statisticsObj.employee.listTeam[0].department.name);
				$('#detailTeam').val(statisticsObj.employee.listTeam[0].name);
			}
			
			$('#detailWithPaying').val(statisticsObj.timeOffWithPaying);
			$('#detailWithoutPaying').val(statisticsObj.timeOffWithoutPaying);
			
			var employeeOffStatus = $.grep(statisticsObj.employee.listEmployeeOffStatus, function(e){ return e.validFlag == 1; });
			if (employeeOffStatus.length == 0) {
				remainHours = -1;
			} else {
				remainHours = employeeOffStatus[0].remainHours;
			}
			$('#detailRemainDay').val(Math.floor(remainHours/8) + " day " + (remainHours % 8) + " h");
			
			$('#withPayingTable').DataTable({
				destroy: true,
				searching: false,
				info: false,
				lengthChange: false,
				paging: false,
// 				scrollY: '200px',
// 				"scrollCollapse": true,
				data: statisticsObj.listRequestWithPaying,
				columns: [
					{ data: 'fromTime' },
					{ data: 'toTime' },
				]
			});
			
			$('#withoutPayingTable').DataTable({
				destroy: true,
				searching: false,
				info: false,
				lengthChange: false,
				paging: false,
				data: statisticsObj.listRequestWithoutPaying,
				columns: [
					{ data: 'fromTime' },
					{ data: 'toTime' },
				]
			});
			
			$('#detailModal').modal('show');
		});
		
		$("#statisticsTable tbody").on('click', '.editRemainHours', function() {
			var statisticsTable = $('#statisticsTable').DataTable();
			var statisticsObj = statisticsTable.row($(this).parent()).data();
			
			editEmployee = statisticsObj.employee;
			
			$('#editEmployee').val(statisticsObj.employee.name);
			
			var employeeOffStatus = $.grep(statisticsObj.employee.listEmployeeOffStatus, function(e){ return e.validFlag == 1; });
			if (employeeOffStatus.length == 0) {
				remainHours = -1;
			} else {
				editEmployeeOffStatus = employeeOffStatus[0];
				remainHours = employeeOffStatus[0].remainHours;
			}
			$('#editRemainDay').val(Math.floor(remainHours/8) + " day " + (remainHours % 8) + " h");
			$('#editDays').val(Math.floor(remainHours/8));
			$('#editHours').val(remainHours % 8);
			
			$('#editMsg').hide();
			
			$('#editRemainHoursModal').modal('show');
		});
		
		$("#editOk").on('click', function() {
			var days = parseInt($('#editDays').val());
			var hours = parseInt($('#editHours').val());
			console.log("day " + days + " hours : " + hours);
			if (isNaN(parseInt(days)) || parseInt(days) != parseFloat(days) || parseInt(days) < 0) {
				$('#editMsg').html("number of days must be a positive integer").show();
			} else {
				var remainHours = days * 8 + hours;
				eOSRequest = {
					'year_id': editEmployeeOffStatus.companyYearOff.id,
					'employee_id': editEmployee.id,
					'remain_hours': remainHours,
					'update_date': editEmployeeOffStatus.updateDate,
					"valid_flag": 1
				}
				
				console.log(eOSRequest);
				
				$.ajax({
					url : /*[[@{/employeeOffStatus/regist}]]*/,
					type : "post",
					dataType :"json",
					contentType : "application/json",
					data : JSON.stringify(eOSRequest),
					success : function (teamSearchResponse){
						if (teamSearchResponse.status_info.status != 0) {
							$('#alertMessage').html(errors['APIResponseError'](teamSearchResponse.status_info.error)).attr('class', 'alert alert-danger').show();
						}
						$('#editRemainHoursModal').modal('hide');
						var statisticsTable = $('#statisticsTable').DataTable();
						statisticsTable.ajax.reload();
					},
					error : function(e) {
						$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
					}
				});
			}
		});
		
		$("#clearBtn").on('click', function() {
			$('#searchForm input, #searchForm select').val('');
			$('#team').empty().append('<option value=""></option>');
			$.each(listTeam, function(index, team) {
				$('#team').append('<option value="' + team.id + '">' + team.name + '</option>');
			});
		});
		
	});
//]]>
</script>

<body class="content-body">
	<div th:replace="fragments/header"></div>
	<div th:replace="menu"></div>
	<div class="requestOffContentBody">
		<h2>Request Off Statistics</h2>
		<div id="alertMessage" class="alert" style="display:none;"></div>
		<form id="searchForm" class="form-input">
			<div class="form-group">
				<label>From</label>
				<div class="input-group date datepicker" data-provide="datepicker">
					<input id="fromTime" name="from_time" type="text" class="form-control" />
					<div class="input-group-addon">
						<span class="glyphicon glyphicon-th"></span>
					</div>
				</div>
			</div>
			
			<div class="form-group">
				<label>To</label>
				<div class="input-group date datepicker" data-provide="datepicker">
					<input id="toTime" name="to_time" type="text" class="form-control" />
					<div class="input-group-addon">
						<span class="glyphicon glyphicon-th"></span>
					</div>
				</div>
			</div>
			
			<div class="form-group">
				<label>Department</label>
				<select id="department" name="department_id" class="form-control"></select>
			</div>
			
			<div class="form-group">
				<label>Team</label>
				<select id="team" name="team_id" class="form-control"></select>
			</div>
			
			<div class="form-group">
				<label>Employee</label>
				<input id="employee" name="employee" type="text" class="form-control"></input>
			</div>
			
			<div>
				<button id="searchBtn" type="button" class="btn btn-primary">Search</button>
				<button id="clearBtn" type="button" class="btn btn-primary">Clear</button>
			</div>
		</form>
		<div class="table-responsive" style="margin-top:3em;"> 
			<table id="statisticsTable" class="table table-striped table-bordered table-hover table-condensed text-center" style="word-wrap: break-word">
				<col width="3%"/>
	 				<col width="15%"/>
	 				<col width="10%"/>
	 				<col width="10%"/>
	 				<col width="10%"/>
	 				<col width="20%"/>
	 				<col width="20%"/>
	 				<col width="10%"/>
	 				<col width="2%"/>
				<thead>
					<tr>
						<th class="text-center">ID</th>
						<th class="text-center">Name</th>
						<th class="text-center">Department</th>
						<th class="text-center">Team</th>
						<th class="text-center">Position</th>
						<th class="text-center">Time Off with Paying</th>
						<th class="text-center align-middle">Time Off without Paying</th>
						<th class="text-center align-middle">Remain Time</th>
						<th class="text-center align-middle">edit</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		
		<div id="detailModal" class="modal fade bd-example-modal-lg">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" align="center">Details</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<label class="col-sm-3 col-form-label">Employee</label>
							<div class="col-sm-3">
								<input id="detailEmployee" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Position</label>
							<div class="col-sm-3">
								<input id="detailPosition" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Department</label>
							<div class="col-sm-3">
								<input id="detailDepartment" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Team</label>
							<div class="col-sm-3">
								<input id="detailTeam" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Time Off With Paying</label>
							<div class="col-sm-3">
								<input id="detailWithPaying" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
							<label class="col-sm-3 col-form-label">Time Off Without Paying</label>
							<div class="col-sm-3">
								<input id="detailWithoutPaying" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-3 col-form-label">Remain Off Time</label>
							<div class="col-sm-3">
								<input id="detailRemainDay" class="form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<div class="col-md-6">
								<table id="withPayingTable" class="table table-bordered table-hover" style="width: 100%;">
									<caption>Day Off with Paying</caption>
									<thead>
										<tr>
											<th class="col-md-6 text-center">From</th>
											<th class="col-md-6 text-center">To</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
							<div class="col-md-6">
								<table id="withoutPayingTable" class="table table-bordered table-hover" style="width: 100%;">
									<caption>Day Off without Paying</caption>
									<thead>
										<tr>
											<th class="col-md-6 text-center">From</th>
											<th class="col-md-6 text-center">To</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
		<div id="editRemainHoursModal" class="modal fade bd-example-modal-lg">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title" align="center">Edit Remain Off Time</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-sm-1"></div>
							<div id="editMsg" class="alert-danger" style="display: none;"></div>
							<br/>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Employee</label>
							<div class="col-sm-8">
								<input id="editEmployee" class="col-sm-3 form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<div class="row">
							<label class="col-sm-4 col-form-label">Remain Off Time</label>
							<div class="col-sm-8">
								<input id="editRemainDay" class="form-control" type="text" readonly="readonly"></input>
							</div>
						</div>
						<br/>
						<div class="row">
							<label class="col-sm-4 col-form-label">New Remain Time</label>
							<div class="col-sm-2">
								<input id="editDays" class="col-sm-3 form-control" type="text"></input>
							</div>
							<label class="col-sm-1">Days</label>
							<div class="col-sm-1"></div>
							<div class="col-sm-2">
								<select id="editHours" class="form-control"></select>
<!-- 								<input id="editHours" class="form-control" type="text"></input> -->
							</div>
							<label class="col-sm-1 col-form-label">Hours</label>
						</div>
						
					</div>
					<div class="modal-footer">
						<button id="editOk" type="button" class="btn btn-default"> Ok </button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="fragments/footer"></div>
</body>

</html>