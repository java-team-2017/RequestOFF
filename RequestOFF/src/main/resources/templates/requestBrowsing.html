<!DOCTYPE html>
<html>
<head>
	<title>Request Browsing</title>
	<div th:replace="library"></div>
</head>

<script th:inline="javascript">
	/*<![CDATA[*/
		var employeeLoginId;
		var userData;
		
		$(function() {
			var objReturnRequestDetails;
			var listRequest;
			var requestStatus = {
				'1' : 'Saved',
				'2' : 'Approved',
				'3' : 'Denied',
				'4' : 'Responded',
				'5' : 'Waiting'
			};
			
			$.ajax({
				type : "post",
				contentType : "application/json",
				url : /*[[@{/employee/getUser}]]*/,
				data : JSON.stringify({}),
				dataType : 'json',
				success : function(data) {
					userData = data;
					console.log("userData");
					console.log(userData);
					employeeLoginId = data.user.id;
				},
				error : function(e) {
					$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
				}
			});
			
			$('.datepicker').on('changeDate', function(ev){
				$(this).datepicker('hide');
			});
			
			$('#btnSearch').on('click', function(){
				search();
			});
			
			$("#requestForm select").keydown(function(e){
				if(e.keyCode == 13) {
					this.blur();
				}
			});
			
			$(document).keypress(function(e) {
				if(e.which == 13) {
					search();
				}
			});
			
			$('#requestTable').on('click', 'td', function () {
				var position = $(this).index();
				if(position != 0 && position != 6){
					var table = $('#requestTable').DataTable();
					var rowData = table.row(this).data();
					objReturnRequestDetails = rowData;
					console.log(rowData);
					$('#nameDetails').val(rowData.employee.name);
					$('#positionDetails').val(rowData.employee.position.name);
					if(rowData.employee.position.id == 2 || rowData.employee.position.id == 3){
						$('#teamDetails').val(rowData.employee.teamName);
						$('#departmentDetails').val(rowData.employee.departmentName);
					} else if(rowData.employee.position.id == 1){
						$('#teamDetails').val(rowData.employee.listTeam[0].name);
						$('#departmentDetails').val(rowData.employee.listTeam[0].department.name);
					}
					$('#recipientDetails').val(rowData.recipientName);
					$('#fromTimeDetails').val(rowData.fromTime);
					$('#toTimeDetails').val(rowData.toTime);
					$('#reasonDetails').val(rowData.reason);
					$('#statusDetails').val(requestStatus[rowData.status]);
					
					$('#statusDetailsId').val(rowData.status);
					$('#dayOffTypeDetails').val(rowData.dayOffType.name);
					$('#responseMessage').val(rowData.responseMessage);
// 					$('#remainHours').val(getRemainHours(rowData.employee));
					$('#employeeIdDetails').val(rowData.employee.id);
					
// 					if (rowData.recipient.position.id == 2) {
// 						listForward.push(rowData.recipient.team.department.manager);
// 					} else if (rowData.recipient.position.id == 3){
// 						$.each(rowData.recipient.department.listTeam, function (index, team) {
// 							listForward.push(team.leader);
// 						})
// 					}

					if(rowData.status != 5){
						$('#btnApproveModal').prop('disabled', true);
						$('#btnDenyModal').prop('disabled', true);
						$('#btnSendModal').prop('disabled', true);
						$('#btnForward').prop('disabled', true);
						$('#responseMessage').prop('disabled', true);
					} else {
						if (rowData.recipientId == userData.user.id) {
							if (rowData.forwardId != 0 && rowData.forwardName != null) {
								$('#forward').empty().append('<option value = "' + rowData.forwardId + '">' + rowData.forwardName + '</option>');
							}
						}
						$('#btnApproveModal').prop('disabled', false);
						$('#btnDenyModal').prop('disabled', false);
						$('#btnSendModal').prop('disabled', false);
						$('#btnForward').prop('disabled', false);
						$('#responseMessage').prop('disabled', false);
					}
					
					$('#modalDetails').modal('show');
				}
			});
			
			$("#btnApproveModal, #btnDenyModal, #btnSendModal, #btnForward").on('click', function(){
				var requestObj = {
					"id" : objReturnRequestDetails.id ,
					"update_date": objReturnRequestDetails.updateDate
				}
				var selectedValue = $("#forward").val();
				
				//update remain hours when click button Deny
				var remainHours = $('#remainHours').val();
				console.log(remainHours);
				var employeeId = $('#employeeIdDetails').val();
				var requestHours = {
					"from_time" : objReturnRequestDetails.fromTime ,
					"to_time": objReturnRequestDetails.toTime
				}//
				
				if ($(this).attr('id') == 'btnApproveModal') {
					requestObj.status = 2;
				} else if ($(this).attr('id') == 'btnDenyModal') {
					requestObj.status = 3;
				} else if ($(this).attr('id') == 'btnSendModal') {
					requestObj.status = 4;
				} else if ($(this).attr('id') == 'btnForward') {
					requestObj.recipient_id = selectedValue;
				}
				requestObj.response_message = $('#responseMessage').val();
				updateRequest(requestObj);
				
				//calculate remain hours
				$.ajax({
					type : "POST",
					contentType : "application/json",
					url : /*[[@{/request/calculateHours}]]*/,
					dataType : 'json',
					data : JSON.stringify(requestHours),
					success : function(resultData) {
						remainHours = parseInt(remainHours) + parseInt(resultData.hours);
						updateRemainHours(employeeId, remainHours);
					},
					error : function(e) {
						$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
					}
				});
			});
			
			$("#btnApprove, #btnDeny").on('click', function() {
				var status = $(this).attr('id') == 'btnApprove' ? 2 : 3;
				var requestObj = {
					"status" : status
				}
				$('#requestTable input[type="checkbox"]:checked').each(function(){
					var table = $('#requestTable').DataTable();
					var rowData = table.row($(this).parent()).data();
					
					//update remain hours
					var remainHours = getRemainHours(rowData.employee);
					var employeeId = rowData.employee.id;
					console.log(remainHours);
					var requestHours = {
						"from_time" : rowData.fromTime ,
						"to_time": rowData.toTime
					}//

					requestObj.id = rowData.id;
					requestObj.update_date = rowData.updateDate;
					updateRequest(requestObj);
					
					//calculate remain hours
					$.ajax({
						type : "POST",
						contentType : "application/json",
						url : /*[[@{/request/calculateHours}]]*/,
						dataType : 'json',
						data : JSON.stringify(requestHours),
						success : function(resultData) {
							remainHours = parseInt(remainHours) + parseInt(resultData.hours);
							updateRemainHours(employeeId, remainHours);
						},
						error : function(e) {
							$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
						}
					});
				});
			});
			
			$('#requestTable').on('click', '.btnApprove, .btnDeny', function () {
				var table = $('#requestTable').DataTable();
				var rowData = table.row($(this).parent()).data();
				var requestObj = {
					"id" : rowData.id ,
					"update_date": rowData.updateDate
				}
				
				//update remain hours when click button deny
				var remainHours = getRemainHours(rowData.employee);
				var employeeId = rowData.employee.id;
				var requestHours = {
					"from_time" : rowData.fromTime ,
					"to_time": rowData.toTime
				}
				
				if ($(this).hasClass('btnApprove')) {
					requestObj.status = 2;
				} else {
					requestObj.status = 3;
				}
				updateRequest(requestObj);
				
				//calculate remain hours
				$.ajax({
					type : "POST",
					contentType : "application/json",
					url : /*[[@{/request/calculateHours}]]*/,
					dataType : 'json',
					data : JSON.stringify(requestHours),
					success : function(resultData) {
						remainHours = parseInt(remainHours) + parseInt(resultData.hours);
						updateRemainHours(employeeId, remainHours);
					},
					error : function(e) {
						$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
					}
				});
			});
			
			$(document).ready(function(){
				$('[data-toggle="tooltip"]').tooltip();
			});
			
			$('#employee').typeahead({
				name: 'suggest-employee',
				limit: 100,
				hint: false,
				remote: {
					rateLimitWait: 1000,
					url: '/employee/search',
					replace: function (url, uriEncodedQuery){
						return url + "#" + uriEncodedQuery;
					},
					beforeSend: function (jqXhr, settings) {
						jqXhr.setRequestHeader('Content-Type','application/json');
						settings.type = 'POST';
						settings.hasContent = true;
						settings.data = JSON.stringify({"name": $('#employee').val(), "name_match_status": "0"});
					},
					filter: function (data) {
						var result = data.employees;
						var sourceArr = [];
						$.each(result, function(index, object) {
							sourceArr.push(object.name);
						});
						return sourceArr;
					}
				}
			}).bind('typeahead:selected', function(obj, selected, name) {
				$(this).typeahead('setQuery', $("<div/>").html(selected.value).text());
				return false;
			});
			
		});
		
		function updateRemainHours(employeeId, remainHours){
			$.ajax({
				type : "POST",
				contentType : "application/json",
				url : /*[[@{/employeeOffStatus/details}]]*/,
				dataType : 'json',
				data : JSON.stringify({
					"year_id" : (new Date()).getFullYear(),
					"employee_id" : employeeId
				}),
				success : function(resultData) {
					var employeeOffStatusRequest = {
						"year_id" : (new Date()).getFullYear(),
						"employee_id" : employeeId,
						"remain_hours" : remainHours,
						"update_date" : resultData.employee_off_status.updateDate
					};
					console.log(employeeOffStatusRequest);
					$.ajax({
						type : "POST",
						contentType : "application/json",
						url : /*[[@{/employeeOffStatus/regist}]]*/,
						dataType : 'json',
						data : JSON.stringify(employeeOffStatusRequest),
						success : function(returnData) {
						},
						error : function(e) {
							$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-success').show();
						}
					});
				},
				error : function(e) {
					$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-success').show();
				}
			});
		}
		
		function updateRequest(requestObj) {
			if(confirm('Are you sure?')){
				$.ajax({
					type : "POST",
					contentType : "application/json",
					url : /*[[@{/request/regist}]]*/,
					dataType : 'json',
					data : JSON.stringify(requestObj),
					success : function(resultData) {
						$('#modalDetails').modal('hide');
						var loadTable = $('#requestTable').DataTable();
						loadTable.ajax.reload();
					},
					error : function(e) {
						$('#alertMessage').html(errors['APIResponseError'](e)).attr('class', 'alert alert-danger').show();
					}
				});
			}
		}
		
		function search(){
			var requestData = $('#requestForm').serializeJSON();
			var requestSearch = {
				"user_id": userData.user.id,
				"from_time" : requestData.from_time,
				"to_time" : requestData.to_time,
				"status" : requestData.status,
				"name": requestData.name
			};
			
			$('#requestTable').DataTable( {
				ajax: {
					type: "POST",
					contentType: "application/json",
					url : /*[[@{/request/getRequestBrowsing}]]*/,
					dataType : 'json',
					data: function () {
						return JSON.stringify(requestSearch);
					},
					dataSrc: 'requests'
				},
				destroy: true,
				searching: false,
				order: [[ 1, "desc" ]],
				//data: listRequest,
				columns: [
					{
						data: 'status',
						render: function (data, type, row) {
							if(row.status != 5){
								return '<input type="checkbox" class="editor-active" disabled="disabled">';
							} else {
								return '<input type="checkbox" class="editor-active">';
							}
						},
					},
					{ data: 'id' },
					{ data: 'employee.name' },
					{ data: 'fromTime' },
					{ data: 'toTime' },
					{ data: 'reason' },
					{
						data: 'status',
						render: function (data, type, row) {
							if(row.status == 2){
								return '<p>Approved</p>';
							} else if(row.status == 3){
								return '<p>Denied</p>';
							} else if(row.status == 4){
								return '<p>Responded</p>';
							} else if(row.status == 5) {
								return '<a href="#" data-toggle="tooltip" title="Approve" class="btnApprove"><span class="glyphicon glyphicon-ok">&nbsp;&nbsp;<a href="#" data-toggle="tooltip" title="Deny" class="btnDeny"><span class="glyphicon glyphicon-remove"></span></a></a>';
							}
						},
					}
				]
			});
		}
	/*]]>*/
</script>

<body class="content-body">
	<div th:replace="fragments/header"></div>
	<div th:replace="menu"></div>
	
	<div class="requestOffContentBody">			
		<h2>Request Browsing</h2>
		<div id="alertMessage" class="alert" style="display:none;"></div>
			<form id="requestForm" class="form-input">
				<div class="form-group">
					<label class="control-label">Employee: </label>
					<input class="form-control" type="text" name="name" id="employee" placeholder="Input name" value=""></input>
				</div>
						
				<div class="form-group">
					<label class="control-label">Request Status: </label>
					<select name="status" id="status" value="" class="form-control">
						<option value=""></option>
						<option value="2">Approved</option>
						<option value="3">Denied</option>
						<option value="4">Responded</option>
						<option value="5">Waiting</option>
					</select>
				</div>
						
				<div class="form-group">
						<label class="control-label">From: </label>
					<div class="input-group date datepicker" data-provide="datepicker">
						<input type="text" class="form-control" name="from_time" id="from" value=""/>
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-calendar"></span>
						</div>
					</div>
				</div>
						
				<div class="form-group">
						<label class="control-label">To: </label>
					<div class="input-group date datepicker" data-provide="datepicker">
						<input type="text" class="form-control" name="to_time" id="to" value=""/>
						<div class="input-group-addon">
							<span class="glyphicon glyphicon-calendar"></span>
						</div>
					</div>
				</div>
						
				<p>
					<button id="btnSearch" type="button" class="btn btn-primary" value="Search" style="width:76px;">Search</button>&nbsp;&nbsp;
					<button type="reset" class="btn btn-primary" style="width:76px;">Clear</button>
				</p>
			</form>
					
			<div class="table-responsive" style="margin-top:3em;"> 
				<table class="table table-bordered table-striped table-hover" id="requestTable">
					<thead>
						<tr>
							<th class="text-center" name="select" style="width: 40px;"><span>Select</span></th>
							<th class="text-center" name="id" id="id" style="width: 40px;"><span>ID</span></th>
							<th class="text-center" name="name"><span>Employee</span></th>
							<th class="text-center" name="from"><span>From</span></th>
							<th class="text-center" name="to"><span>To</span></th>
							<th class="text-center" name="reason"><span>Reason</span></th>
							<th class="text-center" name="approve"><span>Status</span></th>
						</tr>
					</thead>
					<tbody class="text-center">
					</tbody>
				</table>
			</div>
				
			<button type="button" class="btn btn-primary" id="btnApprove" >Approve</button>&nbsp;&nbsp;
			<button type="button" class="btn btn-primary" style="width:76px;" id="btnDeny">Deny</button>
				
			<div class="modal fade" id="modalDetails" role="dialog">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">�</button>
							<h4 class="modal-title">Details</h4>
						</div>
						
						<div class="modal-body">
							<form class="form-horizontal" id="formModal">
								<label class="col-md-3 control-label">Employee:</label>
								<div class="col-md-9">
									<input id="nameDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Position:</label>
								<div class="col-md-9">
									<input id="positionDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Team:</label>
								<div class="col-md-9">
									<input id="teamDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Department:</label>
								<div class="col-md-9">
									<input id="departmentDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Recipient:</label>
								<div class="col-md-9">
									<input id="recipientDetails" class="form-control" readonly="readonly"></input>
								</div>
								
								<label class="col-md-3 control-label">From:</label>
								<div class="col-md-9">
									<input id="fromTimeDetails" class="form-control" readonly="readonly"></input>
								</div>
								
								<label class="col-md-3 control-label">To:</label>
								<div class="col-md-9">
									<input id="toTimeDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Reason:</label>
								<div class="col-md-9">
									<input id="reasonDetails" class="form-control" readonly="readonly"></input>
								</div>
								
								<label class="col-md-3 control-label">Status:</label>
								<div class="col-md-9">
									<input id="statusDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Day Off Type:</label>
								<div class="col-md-9">
									<input id="dayOffTypeDetails" class="form-control" readonly="readonly"></input>
								</div>
			
								<label class="col-md-3 control-label">Response Message:</label>
								<div class="col-md-9">
									<textarea id="responseMessage" name="responseMessage"
										placeholder="Write message..."
										style="height: 100px; width: 100%;">
									</textarea>
								</div>&nbsp;
								
								<p align="center">
									<button type="button" class="btn btn-default" style="width:76px;" id="btnApproveModal">Approve</button>
									<button type="button" class="btn btn-default" style="width:76px;" id="btnDenyModal">Deny</button>
									<button type="button" class="btn btn-default" style="width:76px;" id="btnSendModal">Send</button>
									<button type="button" class="btn btn-default" style="width:76px;" data-dismiss="modal">Cancel</button>
								</p>
			
								<label> Forward request to : <select name="forward" id="forward" value=""></select>
								</label>
								
								<button type="button" class="btn btn-default btn-sm" id="btnForward">
									<span class="glyphicon glyphicon-share-alt"></span>Forward
								</button>
								
								<input type="hidden" id="statusDetailsId"></input>
								<input type="hidden" id="remainHours"></input>
								<input type="hidden" id="employeeIdDetails"></input>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	<div th:replace="fragments/footer"></div>
</body>
</html>