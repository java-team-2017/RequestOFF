<!DOCTYPE html>
<html>
<head>
	<title>Request Browsing</title>
	<link rel="stylesheet" type="text/css" href="css/layoutStyle.css" />
	<link rel="stylesheet" type="text/css" href="css/common.css" />
	<link rel="stylesheet"	type="text/css" href="css/bootstrap.min.css" />
	<link rel="stylesheet"	type="text/css" href="css/notify.css" />
	<link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.css"/>
	<link rel="stylesheet" type="text/css" href="css/datatables.min.css"/>
	<script src="javascript/jquery-3.2.1.js"></script>
	<script src="javascript/bootstrap.min.js"></script>
	<script src="javascript/jquery.serializejson.js"></script>
	<script src="javascript/common.js"></script>
	<script src="javascript/notify.js"></script>
	<script type="text/javascript" src="javascript/datatables.min.js"></script>
	<script type="text/javascript" src="javascript/bootstrap-confirmation.min.js"></script>
	<script type="text/javascript" src="javascript/bootstrap-datepicker.min.js"></script>
</head>
<body class="content-body">
	<script th:inline="javascript">
	/*<![CDATA[*/
		var employeeLoginId;
		$(function() {
			var objReturnRequestDetails;
			var listRequest;
			var requestStatus = {
				'1' : 'Saved',
				'2' : 'Approved',
				'3' : 'Denied',
				'4' : 'Responded',
				'5' : 'Waiting'
			};
			
			$.ajax({
				type : "post",
				contentType : "application/json",
				url : /*[[@{/employee/getUser}]]*/,
				data : JSON.stringify({}),
				dataType : 'json',
				success : function(data) {
					employeeLoginId = data.user.id;
				},
				error : function() {
					alert("Error");
				}
			});
			
			$('#btnSearch').on('click', function(){
				search();
			});
			
			$('#requestTable').on('click', 'td', function () {
				var childTag = $(this).children();
				if(childTag.length == 0){
					var table = $('#requestTable').DataTable();
					var rowData = table.row(this).data();
					objReturnRequestDetails = rowData;
					$('#recipientDetails').val(rowData.recipient.name);
					$('#nameDetails').val(rowData.employee.name);
					$('#positionDetails').val(rowData.employee.position.name);
					$('#teamDetails').val(rowData.employee.listTeam[0].name);
					$('#departmentDetails').val(rowData.employee.listTeam[0].department.name);
					$('#fromTimeDetails').val(rowData.fromTime);
					$('#toTimeDetails').val(rowData.toTime);
					$('#reasonDetails').val(rowData.reason);
					$('#statusDetails').val(requestStatus[rowData.status]);
					$('#statusDetailsId').val(rowData.status);
					$('#dayOffTypeDetails').val(rowData.dayOffType.name);
					$('#responseMessage').val(rowData.responseMessage);
					
					var listForward = []; 
					
					if (rowData.recipient.position.id == 2) {
						listForward.push(rowData.recipient.team.department.manager);
					} else if (rowData.recipient.position.id == 3){
						$.each(rowData.recipient.department.listTeam, function (index, team) {
							listForward.push(team.leader);
						})
					}
					$('#forward').empty();
					$.each(listForward, function(index, recipient) {
						$('#forward').append('<option value = "' + recipient.id + '">' + recipient.name + '</option>');
					});
					
					if($('#statusDetailsId').val() != 5){
						$('#btnApproveModal').prop('disabled', true);
						$('#btnDenyModal').prop('disabled', true);
						$('#btnSendModal').prop('disabled', true);
					} else {
						$('#btnApproveModal').prop('disabled', false);
						$('#btnDenyModal').prop('disabled', false);
						$('#btnSendModal').prop('disabled', false);
					}
					
					$('#modalDetails').modal('show');
				}
			});
			
			$("#btnApprove, #btnDeny").on('click', function() {
				var status = $(this).attr('id') == 'btnApprove' ? 2 : 3;
				var requestObj = {
					"status" : status
				}
	// 			console.log($(this).attr('id'));
	// 			console.log(requestObj);
				$('#requestTable input[type="checkbox"]:checked').each(function(){
						var table = $('#requestTable').DataTable();
						var rowData = table.row($(this).parent()).data();
						
						requestObj.id = rowData.id;
						requestObj.update_date = rowData.updateDate;
						updateRequest(requestObj);
				});
			});
			
			$('#requestTable').on('click', '.btnApprove, .btnDeny', function () {
				var table = $('#requestTable').DataTable();
				var rowData = table.row($(this).parent()).data();
				var requestObj = {
					"id" : rowData.id ,
					"update_date": rowData.updateDate
					}
	// 			console.log(rowData);
				if ($(this).hasClass('btnApprove')) {
					requestObj.status = 2;
				} else {
					requestObj.status = 3;
				}
				updateRequest(requestObj);
			});
			
			$("#btnApproveModal, #btnDenyModal, #btnSendModal, #btnForward").on('click', function(){
				var requestObj = {
					"id" : objReturnRequestDetails.id ,
					"update_date": objReturnRequestDetails.updateDate
				}
	// 			if($('#statusDetails').val(data.request.status) == 2 ){
	// 				$('#btnApproveModal').attr('disabled','disabled');
	// 			}
				var selectedValue = $("#forward").val();
				if ($(this).attr('id') == 'btnApproveModal') {
					requestObj.status = 2;
				} else if ($(this).attr('id') == 'btnDenyModal') {
					requestObj.status = 3;
				} else if ($(this).attr('id') == 'btnSendModal') {
					requestObj.status = 5;
				} else if ($(this).attr('id') == 'btnForward') {
					requestObj.recipient_id = selectedValue;
				}
				requestObj.response_message = $('#responseMessage').val();
				updateRequest(requestObj);
			});
		});
		
		function updateRequest(requestObj) {
			$.ajax({
				type : "POST",
				contentType : "application/json",
				url : /*[[@{/request/regist}]]*/,
				dataType : 'json',
				data : JSON.stringify(requestObj),
				success : function(resultData) {
					search();
				},
				error : function() {
					console.log("Error");
				}
			});
		}
		
		function search(){
			var requestData = $('#requestForm').serializeJSON();
// 				console.log(requestData);
			$('#requestTable').DataTable( {
				ajax: {
					type: "POST",
					contentType: "application/json",
					url : /*[[@{/request/search}]]*/,
					dataType : 'json',
					data: function () {
						return JSON.stringify({"recipient_id": employeeLoginId});
// 						console.log(requestData);
					},
					dataSrc: 'requests'
				},
				destroy: true,
				searching: false,
				//data: listRequest,
				columns: [
					{
						render: function () {
							return '<input type="checkbox" class="editor-active" >';
						},
					},
					{ data: 'id' },
					{ data: 'employee.name' },
					{ data: 'fromTime' },
					{ data: 'toTime' },
					{ data: 'reason' },
					{
						render: function () {
							return '<a href="#" class="btnApprove"><span class="glyphicon glyphicon-ok"></span></a>';
						},
					},{
						render: function () {
							return '<a href="#" class="btnDeny"><span class="glyphicon glyphicon-remove"></span></a>';
						},
					}
				]
			});
			
			
			
// 			console.log("status: ");
// 			console.log(requestData.status);
// 			if(requestData.status != 5){
// // 				var table = $('#requestTable').DataTable();
// 				$("input[type='checkbox']").prop("disabled", true);
// // 				table.column(5).prop("disabled", true);
// // 				table.column(6).prop("disabled", true);
// // 				table.column(7).prop("disabled", true);
// 			}
		}
	/*]]>*/
	</script>
		<div th:replace="fragments/header"></div>
		<div th:replace="menu"></div>
	
		<div class="requestOffContentBody">			
			<div>
				<h2>Request Browsing</h2>
					<form id="requestForm" class="form-input">
						<div class="form-group">
							<label class="control-label">Employee: </label>
							<input class="form-control" type="text" name="name" id="employee" value=""></input>
						</div>
						
						<div class="form-group">
							<label class="control-label">Request Status: </label>
							<select name="status" id="status" value="" class="form-control">
								<option value=""></option>
								<option value="2">Approved</option>
								<option value="3">Denied</option>
								<option value="4">Responded</option>
								<option value="5">Waiting</option>
							</select>
						</div>
						
						<div class="form-group">
								<label class="control-label">From: </label>
							<div class="input-group date" data-provide="datepicker">
								<input type="text" class="form-control" name="from_time" id="from" value=""/>
								<div class="input-group-addon">
									<span class="glyphicon glyphicon-calendar"></span>
								</div>
							</div>
						</div>
						
						<div class="form-group">
								<label class="control-label">To: </label>
							<div class="input-group date" data-provide="datepicker">
								<input type="text" class="form-control" name="to_time" id="to" value=""/>
								<div class="input-group-addon">
									<span class="glyphicon glyphicon-calendar"></span>
								</div>
							</div>
						</div>
						
						<p>
							<button id="btnSearch" type="button" class="btn btn-primary" style="width:76px;">Search</button>&nbsp;&nbsp;
							<button type="reset" class="btn btn-primary" style="width:76px;">Clear</button>
						</p>
				</form>
					
				<div class="table-responsive" style="margin-top:3em;"> 
					<table class="table table-bordered table-striped table-hover" id="requestTable">
						<thead>
							<tr>
								<th class="text-center" name="select"><span>Select</span></th>
								<th class="text-center" name="id" id="id"><span>ID</span></th>
								<th class="text-center" name="name"><span>Employee</span></th>
								<th class="text-center" name="from"><span>From</span></th>
								<th class="text-center" name="to"><span>To</span></th>
								<th class="text-center" name="reason"><span>Reason</span></th>
								<th class="text-center" name="approve"><span>Approve</span></th>
								<th class="text-center" name="deny"><span>Deny</span></th>
							</tr>
						</thead>
						<tbody class="text-center">
						<tr>
						</tr>
						</tbody>
					</table>
				</div>
				
				<button type="button" class="btn btn-primary" id="btnApprove" >Approve</button>&nbsp;&nbsp;
				<button type="button" class="btn btn-primary" style="width:76px;" id="btnDeny">Deny</button>
				
				<div class="modal fade" id="modalDetails" role="dialog">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">ï¿½</button>
								<h4 class="modal-title">Details</h4>
							</div>
							
							<div class="modal-body">
								<form class="form-horizontal" id="formModal">
									<label class="col-md-3 control-label">Employee:</label>
									<div class="col-md-9">
										<input id="nameDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Position:</label>
									<div class="col-md-9">
										<input id="positionDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Team:</label>
									<div class="col-md-9">
										<input id="teamDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Department:</label>
									<div class="col-md-9">
										<input id="departmentDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Recipient:</label>
									<div class="col-md-9">
										<input id="recipientDetails" class="form-control" readonly="readonly"></input>
									</div>
									
									<label class="col-md-3 control-label">From:</label>
									<div class="col-md-9">
										<input id="fromTimeDetails" class="form-control" readonly="readonly"></input>
									</div>
									
									<label class="col-md-3 control-label">To:</label>
									<div class="col-md-9">
										<input id="toTimeDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Reason:</label>
									<div class="col-md-9">
										<input id="reasonDetails" class="form-control" readonly="readonly"></input>
									</div>
									
									<label class="col-md-3 control-label">Status:</label>
									<div class="col-md-9">
										<input id="statusDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<label class="col-md-3 control-label">Day Off Type:</label>
									<div class="col-md-9">
										<input id="dayOffTypeDetails" class="form-control" readonly="readonly"></input>
									</div>
				
									<div class="form-group">
										<label>Response Message:</label>
										<textarea id="responseMessage" name="responseMessage"
											placeholder="Write message..."
											style="height: 115px; width: 100%;">
										</textarea>
									</div>
									
									<p align="center">
										<button type="button" class="btn btn-default" style="width:76px;" id="btnApproveModal">Approve</button>
										<button type="button" class="btn btn-default" style="width:76px;" id="btnDenyModal">Deny</button>
										<button type="button" class="btn btn-default" style="width:76px;" id="btnSendModal">Send</button>
										<button type="button" class="btn btn-default" style="width:76px;" data-dismiss="modal">Cancel</button>
									</p>
				
									<label> Forward request to : <select name="forward" id="forward" value=""></select>
									</label>
									
									<button type="button" class="btn btn-default btn-sm" id="btnForward">
										<span class="glyphicon glyphicon-share-alt"></span>Forward
									</button>
									
									<input type="hidden" id="statusDetailsId"></input>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<div th:replace="fragments/footer"></div>
</body>
</html>